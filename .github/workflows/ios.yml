name: ðŸŽ iOS Build - tinhocstar

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
        - release
        - debug

env:
  FLUTTER_VERSION: '3.24.3'
  XCODE_VERSION: '16.0'

jobs:
  build-ios:
    name: ðŸ—ï¸ Build iOS App
    runs-on: macos-14
    timeout-minutes: 30
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ðŸ”§ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
    
    - name: ðŸ“‹ Flutter Doctor
      run: |
        flutter doctor -v
        flutter --version
        xcodebuild -version
    
    - name: ðŸ“¦ Get Dependencies
      run: |
        flutter clean
        flutter pub get
        flutter pub deps
    
    - name: ðŸ” Analyze Code
      run: flutter analyze --no-fatal-infos
    
    - name: ðŸ§ª Run Tests
      run: flutter test
      continue-on-error: true
    
    - name: ðŸ“± Verify iOS Project
      run: |
        # Kiá»ƒm tra iOS project Ä‘Ã£ cÃ³
        if [ -d "ios" ]; then
          echo "âœ… iOS project already exists"
          ls -la ios/
        else
          echo "âŒ iOS project not found, creating..."
          flutter create --platforms=ios .
        fi
    
    - name: âš™ï¸ Configure iOS Project
      run: |
        # Cáº­p nháº­t Bundle ID unique
        BUNDLE_ID="com.github.actions.tinhocstar"
        echo "ðŸ“± Setting Bundle ID: $BUNDLE_ID"
        
        # Update project.pbxproj
        sed -i '' "s/com\.example\.tinhocstar/$BUNDLE_ID/g" ios/Runner.xcodeproj/project.pbxproj
        sed -i '' "s/PRODUCT_BUNDLE_IDENTIFIER = com\.example\.[^;]*/PRODUCT_BUNDLE_IDENTIFIER = $BUNDLE_ID/g" ios/Runner.xcodeproj/project.pbxproj
        
        # Update Info.plist
        /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName tinhocstar" ios/Runner/Info.plist 2>/dev/null || \
        /usr/libexec/PlistBuddy -c "Add :CFBundleDisplayName string tinhocstar" ios/Runner/Info.plist
        
        # Set iOS Deployment Target
        sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = [0-9.]*;/IPHONEOS_DEPLOYMENT_TARGET = 12.0;/g' ios/Runner.xcodeproj/project.pbxproj
        
        echo "âœ… iOS configuration completed"
    
    - name: ðŸ–¼ï¸ Setup App Icon
      run: |
        # Táº¡o AppIcon.appiconset náº¿u cÃ³ logo
        if [ -f "assets/images/logo.png" ]; then
          echo "ðŸ–¼ï¸ Setting up app icon..."
          mkdir -p ios/Runner/Assets.xcassets/AppIcon.appiconset
          
          # Copy logo (sáº½ dÃ¹ng kÃ­ch thÆ°á»›c gá»‘c, trong thá»±c táº¿ cáº§n resize)
          cp assets/images/logo.png ios/Runner/Assets.xcassets/AppIcon.appiconset/Icon-App-1024x1024@1x.png
          
          # Táº¡o Contents.json
          cat > ios/Runner/Assets.xcassets/AppIcon.appiconset/Contents.json << 'EOF'
        {
          "images" : [
            {
              "idiom" : "iphone",
              "scale" : "2x",
              "size" : "20x20"
            },
            {
              "idiom" : "iphone",
              "scale" : "3x",
              "size" : "20x20"
            },
            {
              "idiom" : "iphone",
              "scale" : "2x",
              "size" : "29x29"
            },
            {
              "idiom" : "iphone",
              "scale" : "3x",
              "size" : "29x29"
            },
            {
              "idiom" : "iphone",
              "scale" : "2x",
              "size" : "40x40"
            },
            {
              "idiom" : "iphone",
              "scale" : "3x",
              "size" : "40x40"
            },
            {
              "idiom" : "iphone",
              "scale" : "2x",
              "size" : "60x60"
            },
            {
              "idiom" : "iphone",
              "scale" : "3x",
              "size" : "60x60"
            },
            {
              "filename" : "Icon-App-1024x1024@1x.png",
              "idiom" : "ios-marketing",
              "scale" : "1x",
              "size" : "1024x1024"
            }
          ],
          "info" : {
            "author" : "xcode",
            "version" : 1
          }
        }
        EOF
          echo "âœ… App icon configured"
        fi
    
    - name: ðŸ—ï¸ Build iOS App
      run: |
        BUILD_TYPE="${{ github.event.inputs.build_type || 'release' }}"
        echo "ðŸ—ï¸ Building iOS app in $BUILD_TYPE mode..."
        
        if [ "$BUILD_TYPE" = "debug" ]; then
          flutter build ios --debug --no-codesign
        else
          flutter build ios --release --no-codesign
        fi
        
        echo "âœ… iOS build completed"
    
    - name: ðŸ“¦ Create IPA Package
      run: |
        echo "ðŸ“¦ Creating IPA package..."
        cd build/ios/iphoneos
        
        # Táº¡o thÆ° má»¥c Payload
        mkdir -p Payload
        
        # Copy app vÃ o Payload
        cp -r Runner.app Payload/
        
        # Táº¡o IPA
        zip -r tinhocstar-unsigned.ipa Payload/
        
        # Kiá»ƒm tra kÃ­ch thÆ°á»›c
        ls -lh tinhocstar-unsigned.ipa
        
        echo "âœ… IPA package created: tinhocstar-unsigned.ipa"
    
    - name: ðŸ“Š Build Summary
      run: |
        echo "ðŸ“Š Build Summary:"
        echo "- Flutter Version: $(flutter --version | head -n1)"
        echo "- Xcode Version: $(xcodebuild -version | head -n1)"
        echo "- Build Type: ${{ github.event.inputs.build_type || 'release' }}"
        echo "- Bundle ID: com.github.actions.tinhocstar"
        echo "- App Name: tinhocstar"
        
        if [ -f "build/ios/iphoneos/tinhocstar-unsigned.ipa" ]; then
          IPA_SIZE=$(ls -lh build/ios/iphoneos/tinhocstar-unsigned.ipa | awk '{print $5}')
          echo "- IPA Size: $IPA_SIZE"
          echo "âœ… Build successful!"
        else
          echo "âŒ IPA file not found!"
          exit 1
        fi
    
    - name: ðŸ“¤ Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: tinhocstar-ios-${{ github.run_number }}
        path: build/ios/iphoneos/tinhocstar-unsigned.ipa
        retention-days: 30
        compression-level: 6
    
    - name: ðŸ“¤ Upload Build Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          /Users/runner/work/_temp/_runner_file_commands/
          ~/.flutter/logs/
        retention-days: 7
        if-no-files-found: ignore
    
    - name: ðŸ’¬ Comment PR (if PR)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = 'build/ios/iphoneos/tinhocstar-unsigned.ipa';
          
          if (fs.existsSync(path)) {
            const stats = fs.statSync(path);
            const fileSizeInMB = (stats.size / (1024 * 1024)).toFixed(2);
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸŽ **iOS Build Successful!**
              
              ðŸ“± **App**: tinhocstar
              ðŸ“¦ **Size**: ${fileSizeInMB} MB
              ðŸ”— **Download**: Check the "Artifacts" section below
              
              âš ï¸ **Note**: This is an unsigned IPA. You'll need to sideload it using AltStore, 3uTools, or similar tools.`
            });
          }
