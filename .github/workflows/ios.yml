name: ğŸ iOS Build - tinhocstar

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
        - release
        - debug

env:
  FLUTTER_VERSION: '3.24.3'

jobs:
  build-ios:
    name: ğŸ—ï¸ Build iOS App
    runs-on: macos-14
    timeout-minutes: 45

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ”§ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: ğŸ“‹ Flutter Doctor
      run: |
        flutter doctor -v
        flutter --version
        xcodebuild -version

    - name: ğŸ“¦ Get Dependencies
      run: |
        flutter clean
        flutter pub get

    - name: ğŸ” Analyze Code
      run: flutter analyze --no-fatal-infos
      continue-on-error: true

    - name: ğŸ§ª Run Tests
      run: flutter test
      continue-on-error: true
    
    - name: ğŸ“± Verify iOS Project
      run: |
        # Kiá»ƒm tra iOS project Ä‘Ã£ cÃ³
        if [ -d "ios" ]; then
          echo "âœ… iOS project already exists"
          ls -la ios/
        else
          echo "âŒ iOS project not found, creating..."
          flutter create --platforms=ios .
        fi

    - name: âš™ï¸ Configure iOS Project
      run: |
        # Cáº­p nháº­t Bundle ID Ä‘Æ¡n giáº£n
        BUNDLE_ID="com.tinhocstar.app"
        echo "ğŸ“± Setting Bundle ID: $BUNDLE_ID"

        # Update project.pbxproj - cÃ¡ch Ä‘Æ¡n giáº£n hÆ¡n
        if [ -f "ios/Runner.xcodeproj/project.pbxproj" ]; then
          sed -i '' "s/PRODUCT_BUNDLE_IDENTIFIER = [^;]*/PRODUCT_BUNDLE_IDENTIFIER = $BUNDLE_ID/g" ios/Runner.xcodeproj/project.pbxproj
          echo "âœ… Bundle ID updated"
        fi

        # Set iOS Deployment Target
        if [ -f "ios/Runner.xcodeproj/project.pbxproj" ]; then
          sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = [0-9.]*;/IPHONEOS_DEPLOYMENT_TARGET = 12.0;/g' ios/Runner.xcodeproj/project.pbxproj
          echo "âœ… iOS deployment target set to 12.0"
        fi
    
    - name: ğŸ–¼ï¸ Check App Icon
      run: |
        # Chá»‰ kiá»ƒm tra app icon, khÃ´ng táº¡o má»›i
        if [ -f "assets/images/logo.png" ]; then
          echo "âœ… Logo found: assets/images/logo.png"
        else
          echo "â„¹ï¸ No logo found, using default icon"
        fi
    
    - name: ğŸ—ï¸ Build iOS App
      run: |
        echo "ğŸ—ï¸ Building iOS app..."

        # Build vá»›i cÃ¡c flag cÆ¡ báº£n
        flutter build ios --release --no-codesign --verbose

        echo "âœ… iOS build completed"

        # Kiá»ƒm tra káº¿t quáº£ build
        echo "ğŸ” Checking build output..."
        find build -name "*.app" -type d || echo "No .app found"
        ls -la build/ios/ || echo "No ios build directory"
    
    - name: ğŸ“¦ Create IPA Package
      run: |
        echo "ğŸ“¦ Creating IPA package..."

        # TÃ¬m file .app
        APP_PATH=$(find build -name "*.app" -type d | head -n1)
        if [ -z "$APP_PATH" ]; then
          echo "âŒ No .app file found"
          echo "ğŸ” Build directory contents:"
          find build -type f -name "*" | head -20
          exit 1
        fi

        echo "âœ… Found app at: $APP_PATH"

        # Táº¡o IPA Ä‘Æ¡n giáº£n
        mkdir -p Payload
        cp -r "$APP_PATH" Payload/
        zip -r tinhocstar-unsigned.ipa Payload/

        # Kiá»ƒm tra káº¿t quáº£
        if [ -f "tinhocstar-unsigned.ipa" ]; then
          ls -lh tinhocstar-unsigned.ipa
          echo "âœ… IPA created successfully"
        else
          echo "âŒ Failed to create IPA"
          exit 1
        fi
    
    - name: ğŸ“Š Build Summary
      run: |
        echo "ğŸ“Š Build Summary:"
        echo "- Flutter Version: $(flutter --version | head -n1)"
        echo "- Build Type: release"
        echo "- Bundle ID: com.tinhocstar.app"

        # Kiá»ƒm tra IPA
        if [ -f "tinhocstar-unsigned.ipa" ]; then
          IPA_SIZE=$(ls -lh tinhocstar-unsigned.ipa | awk '{print $5}')
          echo "- IPA Size: $IPA_SIZE"
          echo "âœ… Build successful!"
        else
          echo "âŒ IPA file not found!"
          exit 1
        fi
    
    - name: ğŸ“¤ Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: tinhocstar-ios-${{ github.run_number }}
        path: tinhocstar-unsigned.ipa
        retention-days: 30
        compression-level: 6
    
    - name: ğŸ“¤ Upload Build Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          /Users/runner/work/_temp/_runner_file_commands/
          ~/.flutter/logs/
        retention-days: 7
        if-no-files-found: ignore
    
    - name: ğŸ’¬ Comment PR (if PR)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = 'tinhocstar-unsigned.ipa';

          if (fs.existsSync(path)) {
            const stats = fs.statSync(path);
            const fileSizeInMB = (stats.size / (1024 * 1024)).toFixed(2);
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ **iOS Build Successful!**
              
              ğŸ“± **App**: tinhocstar
              ğŸ“¦ **Size**: ${fileSizeInMB} MB
              ğŸ”— **Download**: Check the "Artifacts" section below
              
              âš ï¸ **Note**: This is an unsigned IPA. You'll need to sideload it using AltStore, 3uTools, or similar tools.`
            });
          }
