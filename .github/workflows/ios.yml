name: ğŸ iOS Build - tinhocstar

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: 'stable'

jobs:
  debug-ios:
    name: ğŸ” Debug iOS Setup
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true

    - name: ğŸ” System Info
      run: |
        echo "ğŸ–¥ï¸ System Information:"
        uname -a
        sw_vers
        xcode-select --print-path
        xcodebuild -version || echo "Xcode not found"

    - name: ğŸ“‹ Flutter Doctor
      run: |
        echo "ğŸ” Flutter Doctor:"
        flutter doctor -v
        echo "ğŸ“± Flutter build targets:"
        flutter help build

    - name: ğŸ“¦ Test Dependencies
      run: |
        echo "ğŸ“¦ Testing dependencies..."
        flutter clean
        flutter pub get
        flutter pub deps

    - name: ğŸ§ª iOS Build Test
      run: |
        echo "ğŸ§ª Testing iOS build capability..."
        echo "ğŸ“± Checking if iOS build is available:"
        flutter build --help | grep -i ios || echo "iOS build not available"

        echo "ğŸ” Trying actual iOS build:"
        flutter build ios --help || {
          echo "âŒ iOS build command failed"
          echo "ğŸ” Available build targets:"
          flutter build --help
          echo "ğŸ” Flutter doctor output:"
          flutter doctor
          exit 1
        }

        echo "âœ… iOS build command is available"

        echo "ğŸ—ï¸ Attempting actual build:"
        flutter build ios --no-codesign || {
          echo "âŒ iOS build failed"
          echo "ğŸ” Detailed error analysis:"
          echo "System info:"
          uname -a
          echo "Xcode info:"
          xcodebuild -version || echo "Xcode not available"
          echo "iOS simulators:"
          xcrun simctl list devices || echo "No simulators"
          exit 1
        }

        echo "âœ… iOS build completed successfully!"

    
    - name: ğŸ“¤ Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: tinhocstar-ios-${{ github.run_number }}
        path: tinhocstar-unsigned.ipa
        retention-days: 30
        compression-level: 6
    
    - name: ğŸ“¤ Upload Build Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          /Users/runner/work/_temp/_runner_file_commands/
          ~/.flutter/logs/
        retention-days: 7
        if-no-files-found: ignore
    
    - name: ğŸ’¬ Comment PR (if PR)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = 'tinhocstar-unsigned.ipa';

          if (fs.existsSync(path)) {
            const stats = fs.statSync(path);
            const fileSizeInMB = (stats.size / (1024 * 1024)).toFixed(2);
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ **iOS Build Successful!**
              
              ğŸ“± **App**: tinhocstar
              ğŸ“¦ **Size**: ${fileSizeInMB} MB
              ğŸ”— **Download**: Check the "Artifacts" section below
              
              âš ï¸ **Note**: This is an unsigned IPA. You'll need to sideload it using AltStore, 3uTools, or similar tools.`
            });
          }
