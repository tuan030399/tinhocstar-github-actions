name: üçé iOS Build - tinhocstar

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
        - release
        - debug

env:
  FLUTTER_VERSION: '3.24.3'
  XCODE_VERSION: '16.0'

jobs:
  build-ios:
    name: üèóÔ∏è Build iOS App
    runs-on: macos-14
    timeout-minutes: 30
    
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: üîß Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
    
    - name: üìã Flutter Doctor
      run: |
        flutter doctor -v
        flutter --version
        xcodebuild -version
    
    - name: üì¶ Get Dependencies
      run: |
        flutter clean
        flutter pub get
        flutter pub deps
    
    - name: üîç Analyze Code
      run: flutter analyze --no-fatal-infos
    
    - name: üß™ Run Tests
      run: flutter test
      continue-on-error: true
    
    - name: üì± Verify iOS Project
      run: |
        # Ki·ªÉm tra iOS project ƒë√£ c√≥
        if [ -d "ios" ]; then
          echo "‚úÖ iOS project already exists"
          ls -la ios/
        else
          echo "‚ùå iOS project not found, creating..."
          flutter create --platforms=ios .
        fi
    
    - name: ‚öôÔ∏è Configure iOS Project
      run: |
        # C·∫≠p nh·∫≠t Bundle ID unique
        BUNDLE_ID="com.github.actions.tinhocstar"
        echo "üì± Setting Bundle ID: $BUNDLE_ID"
        
        # Update project.pbxproj
        sed -i '' "s/com\.example\.tinhocstar/$BUNDLE_ID/g" ios/Runner.xcodeproj/project.pbxproj
        sed -i '' "s/PRODUCT_BUNDLE_IDENTIFIER = com\.example\.[^;]*/PRODUCT_BUNDLE_IDENTIFIER = $BUNDLE_ID/g" ios/Runner.xcodeproj/project.pbxproj
        
        # Update Info.plist
        /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName tinhocstar" ios/Runner/Info.plist 2>/dev/null || \
        /usr/libexec/PlistBuddy -c "Add :CFBundleDisplayName string tinhocstar" ios/Runner/Info.plist
        
        # Set iOS Deployment Target
        sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = [0-9.]*;/IPHONEOS_DEPLOYMENT_TARGET = 12.0;/g' ios/Runner.xcodeproj/project.pbxproj
        
        echo "‚úÖ iOS configuration completed"
    
    - name: üñºÔ∏è Setup App Icon
      run: |
        # T·∫°o AppIcon.appiconset n·∫øu c√≥ logo
        if [ -f "assets/images/logo.png" ]; then
          echo "üñºÔ∏è Setting up app icon..."
          mkdir -p ios/Runner/Assets.xcassets/AppIcon.appiconset
          
          # Copy logo (s·∫Ω d√πng k√≠ch th∆∞·ªõc g·ªëc, trong th·ª±c t·∫ø c·∫ßn resize)
          cp assets/images/logo.png ios/Runner/Assets.xcassets/AppIcon.appiconset/Icon-App-1024x1024@1x.png
          
          # T·∫°o Contents.json
          cat > ios/Runner/Assets.xcassets/AppIcon.appiconset/Contents.json << 'EOF'
        {
          "images" : [
            {
              "idiom" : "iphone",
              "scale" : "2x",
              "size" : "20x20"
            },
            {
              "idiom" : "iphone",
              "scale" : "3x",
              "size" : "20x20"
            },
            {
              "idiom" : "iphone",
              "scale" : "2x",
              "size" : "29x29"
            },
            {
              "idiom" : "iphone",
              "scale" : "3x",
              "size" : "29x29"
            },
            {
              "idiom" : "iphone",
              "scale" : "2x",
              "size" : "40x40"
            },
            {
              "idiom" : "iphone",
              "scale" : "3x",
              "size" : "40x40"
            },
            {
              "idiom" : "iphone",
              "scale" : "2x",
              "size" : "60x60"
            },
            {
              "idiom" : "iphone",
              "scale" : "3x",
              "size" : "60x60"
            },
            {
              "filename" : "Icon-App-1024x1024@1x.png",
              "idiom" : "ios-marketing",
              "scale" : "1x",
              "size" : "1024x1024"
            }
          ],
          "info" : {
            "author" : "xcode",
            "version" : 1
          }
        }
        EOF
          echo "‚úÖ App icon configured"
        fi
    
    - name: üèóÔ∏è Build iOS App
      run: |
        BUILD_TYPE="${{ github.event.inputs.build_type || 'release' }}"
        echo "üèóÔ∏è Building iOS app in $BUILD_TYPE mode..."
        
        if [ "$BUILD_TYPE" = "debug" ]; then
          flutter build ios --debug --no-codesign
        else
          flutter build ios --release --no-codesign
        fi
        
        echo "‚úÖ iOS build completed"
    
    - name: üì¶ Create IPA Package
      run: |
        echo "üì¶ Creating IPA package..."

        # Ki·ªÉm tra c·∫•u tr√∫c th∆∞ m·ª•c build
        echo "üîç Checking build directory structure..."
        find build -name "*.app" -type d 2>/dev/null || echo "No .app found"
        ls -la build/ios/ 2>/dev/null || echo "No ios build directory"

        # T√¨m file .app
        APP_PATH=$(find build -name "*.app" -type d | head -n1)
        if [ -z "$APP_PATH" ]; then
          echo "‚ùå No .app file found in build directory"
          exit 1
        fi

        echo "‚úÖ Found app at: $APP_PATH"

        # T·∫°o th∆∞ m·ª•c cho IPA
        IPA_DIR="build/ios/ipa"
        mkdir -p "$IPA_DIR/Payload"

        # Copy app v√†o Payload
        cp -r "$APP_PATH" "$IPA_DIR/Payload/"

        # T·∫°o IPA
        cd "$IPA_DIR"
        zip -r tinhocstar-unsigned.ipa Payload/

        # Ki·ªÉm tra k√≠ch th∆∞·ªõc
        ls -lh tinhocstar-unsigned.ipa

        # Copy IPA v·ªÅ th∆∞ m·ª•c g·ªëc ƒë·ªÉ d·ªÖ t√¨m
        cp tinhocstar-unsigned.ipa ../../../

        echo "‚úÖ IPA package created: tinhocstar-unsigned.ipa"
    
    - name: üìä Build Summary
      run: |
        echo "üìä Build Summary:"
        echo "- Flutter Version: $(flutter --version | head -n1)"
        echo "- Xcode Version: $(xcodebuild -version | head -n1)"
        echo "- Build Type: ${{ github.event.inputs.build_type || 'release' }}"
        echo "- Bundle ID: com.github.actions.tinhocstar"
        echo "- App Name: tinhocstar"

        # T√¨m file IPA
        IPA_FILE=$(find . -name "tinhocstar-unsigned.ipa" | head -n1)
        if [ -n "$IPA_FILE" ]; then
          IPA_SIZE=$(ls -lh "$IPA_FILE" | awk '{print $5}')
          echo "- IPA Location: $IPA_FILE"
          echo "- IPA Size: $IPA_SIZE"
          echo "‚úÖ Build successful!"
        else
          echo "‚ùå IPA file not found!"
          echo "üîç Searching for any IPA files..."
          find . -name "*.ipa" -type f
          exit 1
        fi
    
    - name: üì§ Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: tinhocstar-ios-${{ github.run_number }}
        path: tinhocstar-unsigned.ipa
        retention-days: 30
        compression-level: 6
    
    - name: üì§ Upload Build Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          /Users/runner/work/_temp/_runner_file_commands/
          ~/.flutter/logs/
        retention-days: 7
        if-no-files-found: ignore
    
    - name: üí¨ Comment PR (if PR)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = 'tinhocstar-unsigned.ipa';

          if (fs.existsSync(path)) {
            const stats = fs.statSync(path);
            const fileSizeInMB = (stats.size / (1024 * 1024)).toFixed(2);
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üçé **iOS Build Successful!**
              
              üì± **App**: tinhocstar
              üì¶ **Size**: ${fileSizeInMB} MB
              üîó **Download**: Check the "Artifacts" section below
              
              ‚ö†Ô∏è **Note**: This is an unsigned IPA. You'll need to sideload it using AltStore, 3uTools, or similar tools.`
            });
          }
