name: 🍎 iOS Build - tinhocstar

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.24.3'

jobs:
  build-ios:
    name: 🏗️ Build iOS App
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4

    - name: 🔧 Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: 📋 Flutter Doctor
      run: |
        echo "🔍 Checking Flutter installation..."
        flutter doctor -v
        flutter --version
        echo "✅ Flutter check completed"

    - name: 📦 Get Dependencies
      run: |
        echo "📦 Getting Flutter dependencies..."
        flutter clean
        flutter pub get
        echo "✅ Dependencies completed"

    - name: 🔍 Check Flutter iOS Support
      run: |
        echo "🔍 Checking Flutter iOS support..."
        flutter doctor -v
        flutter config --list
        echo "📱 Available build targets:"
        flutter help build

    - name: 🏗️ Build iOS App
      run: |
        echo "🏗️ Building iOS app..."

        # Kiểm tra iOS project trước
        echo "📂 Checking iOS project structure..."
        ls -la ios/

        # Thử build với verbose để xem lỗi chi tiết
        echo "🔨 Starting iOS build..."
        flutter build ios --no-codesign --verbose || {
          echo "❌ Build failed, showing detailed error info..."
          echo "🔍 Flutter doctor:"
          flutter doctor
          echo "🔍 iOS project info:"
          cat ios/Runner.xcodeproj/project.pbxproj | grep -A5 -B5 "PRODUCT_BUNDLE_IDENTIFIER"
          echo "🔍 Build directory:"
          ls -la build/ || echo "No build directory"
          exit 1
        }

        echo "✅ iOS build completed successfully!"

        # Kiểm tra output chi tiết
        echo "🔍 Checking build output..."
        find build -type d -name "*.app" || echo "No .app directories found"

        if [ -d "build/ios/iphoneos/Runner.app" ]; then
          echo "✅ App found at: build/ios/iphoneos/Runner.app"
          ls -la build/ios/iphoneos/Runner.app
        else
          echo "⚠️ App not found at expected location, checking alternatives..."
          find build -name "Runner.app" -type d || echo "No Runner.app found anywhere"
        fi

    - name: 📦 Create IPA
      run: |
        echo "📦 Creating IPA package..."

        # Tìm app file ở bất kỳ đâu
        APP_PATH=$(find build -name "Runner.app" -type d | head -n1)

        if [ -z "$APP_PATH" ]; then
          echo "❌ No Runner.app found anywhere in build directory"
          echo "🔍 Build directory contents:"
          find build -type f -name "*.app" || echo "No .app files found"
          find build -type d || echo "No directories found"
          exit 1
        fi

        echo "✅ Found app at: $APP_PATH"

        # Tạo IPA
        mkdir -p Payload
        cp -r "$APP_PATH" Payload/
        zip -r tinhocstar-ios.ipa Payload/

        if [ -f "tinhocstar-ios.ipa" ]; then
          echo "✅ IPA created successfully!"
          ls -lh tinhocstar-ios.ipa
        else
          echo "❌ Failed to create IPA"
          exit 1
        fi

    - name: 📤 Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: tinhocstar-ios-app
        path: tinhocstar-ios.ipa
        retention-days: 30

    - name: 📊 Build Summary
      run: |
        echo "📊 Build Summary:"
        echo "- Flutter Version: $(flutter --version | head -n1)"
        echo "- Build Type: Release (unsigned)"
        echo "- IPA Size: $(ls -lh tinhocstar-ios.ipa | awk '{print $5}')"
        echo "- Build Time: $(date)"
        echo "- Platform: iOS"
        echo "✅ Build completed successfully!"
    
    - name: 📤 Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: tinhocstar-ios-${{ github.run_number }}
        path: tinhocstar-unsigned.ipa
        retention-days: 30
        compression-level: 6
    
    - name: 📤 Upload Build Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          /Users/runner/work/_temp/_runner_file_commands/
          ~/.flutter/logs/
        retention-days: 7
        if-no-files-found: ignore
    
    - name: 💬 Comment PR (if PR)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = 'tinhocstar-unsigned.ipa';

          if (fs.existsSync(path)) {
            const stats = fs.statSync(path);
            const fileSizeInMB = (stats.size / (1024 * 1024)).toFixed(2);
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `🍎 **iOS Build Successful!**
              
              📱 **App**: tinhocstar
              📦 **Size**: ${fileSizeInMB} MB
              🔗 **Download**: Check the "Artifacts" section below
              
              ⚠️ **Note**: This is an unsigned IPA. You'll need to sideload it using AltStore, 3uTools, or similar tools.`
            });
          }
