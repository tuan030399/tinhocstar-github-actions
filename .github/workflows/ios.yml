name: üçé iOS Build - tinhocstar

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  basic-test:
    name: üß™ Basic Environment Test
    runs-on: macos-latest
    timeout-minutes: 20

    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4

    - name: üñ•Ô∏è System Check
      run: |
        echo "=== SYSTEM INFO ==="
        uname -a
        sw_vers
        echo ""
        echo "=== XCODE CHECK ==="
        xcode-select --print-path || echo "‚ùå Xcode path not set"
        xcodebuild -version || echo "‚ùå Xcode not available"
        echo ""
        echo "=== AVAILABLE TOOLS ==="
        which flutter || echo "‚ùå Flutter not in PATH"
        which dart || echo "‚ùå Dart not in PATH"

    - name: üîß Setup Flutter (Latest Stable)
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: false

    - name: üìã Flutter Environment
      run: |
        echo "=== FLUTTER INFO ==="
        flutter --version
        echo ""
        echo "=== FLUTTER DOCTOR ==="
        flutter doctor -v
        echo ""
        echo "=== FLUTTER CONFIG ==="
        flutter config

    - name: üì¶ Project Dependencies
      run: |
        echo "=== PROJECT STRUCTURE ==="
        ls -la
        echo ""
        echo "=== PUBSPEC CHECK ==="
        cat pubspec.yaml | head -20
        echo ""
        echo "=== DEPENDENCIES ==="
        flutter pub get

    - name: üéØ iOS Capability Test
      run: |
        echo "=== iOS BUILD AVAILABILITY ==="
        flutter build --help | grep -A5 -B5 ios || echo "‚ùå iOS not in build help"
        echo ""
        echo "=== DIRECT iOS TEST ==="
        flutter build ios --help || echo "‚ùå iOS build help failed"

    - name: üîç iOS Project Analysis
      run: |
        echo "=== iOS PROJECT STRUCTURE ==="
        ls -la ios/
        echo ""
        echo "=== PODFILE CHECK ==="
        cat ios/Podfile || echo "‚ùå No Podfile found"
        echo ""
        echo "=== RUNNER PROJECT ==="
        ls -la ios/Runner/
        echo ""
        echo "=== XCODEPROJ CHECK ==="
        ls -la ios/Runner.xcodeproj/

    - name: üèóÔ∏è Step-by-Step Build
      run: |
        echo "=== STEP 1: Flutter Clean ==="
        flutter clean

        echo "=== STEP 2: Pub Get ==="
        flutter pub get

        echo "=== STEP 3: iOS Preconditions ==="
        flutter precache --ios

        echo "=== STEP 4: CocoaPods Setup ==="
        cd ios
        pod --version || echo "‚ùå CocoaPods not available"
        pod repo update || echo "‚ö†Ô∏è Pod repo update failed"
        cd ..

        echo "=== STEP 5: Attempt Build ==="
        flutter build ios --no-codesign --debug || {
          echo "‚ùå DEBUG BUILD FAILED"
          echo "=== DETAILED ERROR INFO ==="
          cd ios
          xcodebuild -workspace Runner.xcworkspace -scheme Runner -configuration Debug -destination 'generic/platform=iOS' build || echo "Xcode build also failed"
          cd ..
          exit 1
        }
        echo "‚úÖ DEBUG BUILD SUCCESS"

    
    - name: üì§ Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: tinhocstar-ios-${{ github.run_number }}
        path: tinhocstar-unsigned.ipa
        retention-days: 30
        compression-level: 6
    
    - name: üì§ Upload Build Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          /Users/runner/work/_temp/_runner_file_commands/
          ~/.flutter/logs/
        retention-days: 7
        if-no-files-found: ignore
    
    - name: üí¨ Comment PR (if PR)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = 'tinhocstar-unsigned.ipa';

          if (fs.existsSync(path)) {
            const stats = fs.statSync(path);
            const fileSizeInMB = (stats.size / (1024 * 1024)).toFixed(2);
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üçé **iOS Build Successful!**
              
              üì± **App**: tinhocstar
              üì¶ **Size**: ${fileSizeInMB} MB
              üîó **Download**: Check the "Artifacts" section below
              
              ‚ö†Ô∏è **Note**: This is an unsigned IPA. You'll need to sideload it using AltStore, 3uTools, or similar tools.`
            });
          }
